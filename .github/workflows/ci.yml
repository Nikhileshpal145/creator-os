name: Creator OS CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  # =====================
  # Backend Tests
  # =====================
  backend-test:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./backend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint with Ruff
        run: ruff check app/

      - name: Test with Pytest
        run: PYTHONPATH=. pytest

  # =====================
  # Web App Tests
  # =====================
  web-app-test:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./web-app

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web-app/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Test
        run: npm run test -- --run

      - name: Build
        run: npm run build

  # =====================
  # Extension Lint
  # =====================
  extension-lint:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./extension

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: extension/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build extension
        run: npm run build

  # =====================
  # Production Config Sanity Check
  # =====================
  production-config-check:
    runs-on: ubuntu-latest
    needs: [backend-test]

    defaults:
      run:
        working-directory: ./backend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prod sanity - missing TOKEN_ENCRYPTION_KEY should fail
        run: |
          python - <<'PY'
          import importlib, sys, os
          os.environ['ENVIRONMENT'] = 'production'
          os.environ.pop('TOKEN_ENCRYPTION_KEY', None)
          os.environ['SECRET_KEY'] = 'ci-fake-secret'
          # Ensure fresh import
          if 'app.core.config' in sys.modules:
              del sys.modules['app.core.config']
          try:
              importlib.import_module('app.core.config')
              print('ERROR: config import succeeded but should have failed without TOKEN_ENCRYPTION_KEY')
              sys.exit(1)
          except Exception as e:
              if 'TOKEN_ENCRYPTION_KEY' in str(e):
                  print('Expected failure detected:', e)
                  sys.exit(0)
              else:
                  print('Unexpected error:', e)
                  raise
          PY

      - name: Prod sanity - invalid TOKEN_ENCRYPTION_KEY should fail
        run: |
          python - <<'PY'
          import importlib, sys, os
          os.environ['ENVIRONMENT'] = 'production'
          os.environ['TOKEN_ENCRYPTION_KEY'] = 'not-a-valid-fernet-key'
          os.environ['SECRET_KEY'] = 'ci-fake-secret'
          if 'app.core.config' in sys.modules:
              del sys.modules['app.core.config']
          try:
              importlib.import_module('app.core.config')
              print('ERROR: config import succeeded but should have failed with invalid TOKEN_ENCRYPTION_KEY')
              sys.exit(1)
          except Exception as e:
              msg = str(e)
              if 'Invalid TOKEN_ENCRYPTION_KEY' in msg or 'Fernet' in msg or 'TOKEN_ENCRYPTION_KEY' in msg:
                  print('Expected invalid-key failure detected:', msg)
                  sys.exit(0)
              else:
                  print('Unexpected error:', msg)
                  raise
          PY

      - name: Prod sanity - valid TOKEN_ENCRYPTION_KEY allowed
        run: |
          python - <<'PY'
          import importlib, sys, os
          from cryptography.fernet import Fernet
          os.environ['ENVIRONMENT'] = 'production'
          os.environ['TOKEN_ENCRYPTION_KEY'] = Fernet.generate_key().decode()
          os.environ['SECRET_KEY'] = 'ci-fake-secret'
          if 'app.core.config' in sys.modules:
              del sys.modules['app.core.config']
          cfg = importlib.import_module('app.core.config')
          print('Success: config loaded with a valid TOKEN_ENCRYPTION_KEY')
          sys.exit(0)
          PY

  # =====================
  # Docker Build Verification
  # =====================
  docker-build:
    runs-on: ubuntu-latest
    needs: [backend-test, web-app-test]

    steps:
      - uses: actions/checkout@v4

      - name: Build backend Docker image
        run: docker build ./backend -t creator-os-backend:test

      - name: Build web-app Docker image
        run: docker build ./web-app -t creator-os-web-app:test
